
/* Smart UI v8.0.0 (2020-Aug) 
Copyright (c) 2011-2020 jQWidgets. 
License: https://htmlelements.com/license/ */ //

!function(e){var t={};function a(l){if(t[l])return t[l].exports;var i=t[l]={i:l,l:!1,exports:{}};return e[l].call(i.exports,i,i.exports,a),i.l=!0,i.exports}a.m=e,a.c=t,a.d=function(e,t,l){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:l})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var l=Object.create(null);if(a.r(l),Object.defineProperty(l,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)a.d(l,i,function(t){return e[t]}.bind(null,i));return l},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a(a.s=88)}({88:function(e,t){Smart("smart-pivot-table",class extends Smart.Table{static get properties(){return{columnTotals:{value:!1,type:"boolean"},columnTotalsPosition:{value:"near",allowedValues:["near","far"],type:"string"},designer:{value:!1,type:"boolean"},designerPosition:{value:"far",allowedValues:["near","far"],type:"string"},drillDown:{value:!1,type:"boolean"},getDefaultSummaryFunction:{value:null,type:"function?"},grandTotal:{value:!1,type:"boolean"},groupLayout:{value:"default",allowedValues:["default","classic"],type:"string"},messages:{value:{en:{calculation:"Calculation",center:"center",clear:"Clear",columns:"Columns",columnSettings:"Column settings",decimalPlaces:"Decimal places",decimalSeparator:"Decimal separator",details:"Details",dragHereRowGroups:"Drag here to set row groups",dragHereSummaries:"Drag here to set summaries",dragHerePivots:"Drag here to set pivots",fields:"Fields",filter:"Filter",filters:"Filters",grandTotal:"Grand Total",groupHeader:"Group",left:"left",moveTo:"Move to",negativesInBrackets:"Negatives in brackets",numberAlignment:"Number alignment",numberFormat:"Number format",numberPrefix:"Number prefix",notApplicable:"N/A",pivots:"Pivots",right:"right",row:"Row",rowGroups:"Row Groups",sameSummaryFunctionRequired:'smartPivotTable: When "columnTotals" is enabled, all summary columns must have the same "summary" function set (e.g. \'{{example}}\').',search:"Search...",showRows:"Show records where:",summaries:"Summaries",summaryRequired:'smartPivotTable: At least one column with "summary" is required.',textAlignment:"Text alignment",total:"Total",thousandsSeparator:"Thousands separator"}},type:"object",extend:!0},rowTotals:{value:!1,type:"boolean"},rowTotalsPosition:{value:"near",allowedValues:["near","far"],type:"string"},toolbar:{value:!1,type:"boolean"}}}static get listeners(){return{resize:"_overriddenTableHandler","designerContainer.change":"_designerChangeHandler","designerContainer.clear":"_designerFilterHandler","designerContainer.filter":"_designerFilterHandler","fieldsButton.click":"_fieldsButtonClickHandler","tableContainer.change":"_overriddenTableHandler","tableContainer.keyup":"_overriddenTableHandler","toolbar.close":"_breadcrumbCloseHandler","toolbar.dragEnd":"_breadcrumbDragEndHandler","toolbar.dragging":"_breadcrumbDraggingHandler"}}template(){return'<div id="container" class="smart-container" role="presentation">\n                    <div id="toolbar" class="smart-pivot-table-toolbar" role="toolbar">\n                        <smart-breadcrumb id="rowGroupBreadcrumb" class="smart-pivot-table-row-group-breadcrumb" allow-drag allow-drop animation="[[animation]]" close-buttons right-to-left="[[rightToLeft]]" theme="[[theme]]"></smart-breadcrumb>\n                        <smart-breadcrumb id="pivotBreadcrumb" class="smart-pivot-table-pivot-breadcrumb" allow-drag allow-drop animation="[[animation]]" close-buttons right-to-left="[[rightToLeft]]" theme="[[theme]]"></smart-breadcrumb>\n                        <smart-button id="conditionalFormattingButton" class="smart-table-toolbar-button conditional-formatting" animation="[[animation]]" right-to-left="[[rightToLeft]]" theme="[[theme]]" aria-label="Conditional Formatting"></smart-button>\n                        <smart-button id="fieldsButton" class="smart-table-toolbar-button fields" animation="[[animation]]" right-to-left="[[rightToLeft]]" theme="[[theme]]" aria-label="Fields"></smart-button>\n                    </div>\n                    <div id="main" class="smart-pivot-table-main-container">\n                        <table id="tableContainer" class="smart-table-container"></table>\n                    </div>\n                    <div id="designerContainer" class="smart-pivot-table-designer-container"></div>\n                </div>'}clearFilters(){this._filterInfo.appliedFilters&&(delete this._filterInfo.appliedFilters,this._clearDesignerFilters(),this.dataSource.clearFilter(),this.refresh(!0),this.$.fireEvent("filter",{action:"remove"}))}exportData(e,t,a){const l=this,i=getComputedStyle(l),r=i.borderRightColor,n={hierarchical:!0},o={},s=l._dynamicColumns;let d=[];if(s&&0!==s.length){if(n.style={border:"1px solid "+r,borderCollapse:"collapse",backgroundColor:i.backgroundColor,color:i.color,fontFamily:"Helvetica",header:{border:"1px solid "+r,fontWeight:"bold"},columns:{border:"1px solid "+r}},-1!==["csv","json","tsv","xml"].indexOf(e)){for(let e=0;e<s.length;e++){const t=s[e];t.group?o[t.id]=t.label:o[t.id]=t.dataFields.map(e=>e.label).join(" -> ")}d.push(o)}else{const e=[],t=[];for(let a=0;a<s.length;a++){const i=s[a],r=i.id,o={},d={};if(l._getColumnExportFormat(i,o,d),n.style.columns[r]=d,n.style.header[r]=o,i.group){o.width=1.25*l._cellWidth+"px",e.push({label:i.label,dataField:r});continue}o.width=l._cellWidth+"px";const c=i.dataFields,u={label:c[c.length-1].label,dataField:r};if(e.push(u),1!==c.length)for(let e=c.length-2;e>=0;e--){const a=c[e].label,l=c.slice(0,e+1).map(e=>e.label).join("_").replace(/[ ,]/g,"_");if(e===c.length-2&&(u.columnGroup=l),t.find(e=>e.name===l))continue;const i={label:a,name:l};c[e-1]&&(i.parentGroup=c[e-1].label.replace(/[ ,]/g,"_")),t.push(i)}}o.columns=e,o.columngroups=t,n.header=o}for(let t=0;t<l.rows.length;t++){const a=l.rows[t],i={};for(let t in a){if(-1!==["$","children","expanded","leaf","level","parent","tr"].indexOf(t))continue;if("id"===t){i._keyDataField=a.id;continue}if("parentid"===t){i._parentDataField=a.parentid;continue}const l=a[t];i[t]=0!==l?l:"pdf"===e?" ":""}!0!==a.leaf&&(i._expanded=!0===a.expanded),d.push(i)}return new Smart.Utilities.DataExporter(n).exportData(d,e,t,a)}}getDynamicColumns(){return this._dynamicColumns}sortBy(e,t){const a=this;let l;if(e){if(-1===a._dynamicColumns.indexOf(e)||0===a._rowGroupColumns.length)return;if(!1===e.dataFields[e.dataFields.length-1].originalColumn.allowSort)return;l=e.id}a._sortBy({column:e,columnDataField:l,sortOrder:t,dataFields:a._dynamicDataFields,columnByDataField:"_getDynamicColumnById"})}propertyChangedHandler(e,t,a){const l=this;function i(){l._dynamicColumns.filter(e=>e.rowTotal).forEach(e=>{delete l._getDynamicColumnById[e.id],l._dynamicDataFields=l._dynamicDataFields.filter(t=>t.name!==e.id)}),l._dynamicColumns=l._dynamicColumns.filter(e=>!0!==e.rowTotal)}switch(e){case"animation":case"rightToLeft":case"theme":super.propertyChangedHandler(e,t,a),l._designer&&(l._designer[e]=a,"rightToLeft"===e&&(l._designer.inverted=l.designer&&("near"===l.designerPosition&&!a||"far"===l.designerPosition&&a)));break;case"columns":l._conditionalFormatting&&delete l._conditionalFormatting,l._updateColumns(),l._formattingPanel&&(l._formattingPanel.columns=l._aggregateColumns.map(e=>({label:`${e.summary}(${e.label})`,dataField:e.dataField,dataType:"number"})));break;case"columnTotals":l.refresh(!0);break;case"columnTotalsPosition":{if(!l.columnTotals)return;i();const e=l._dynamicColumns.filter(e=>e.columnTotal&&0===e.pivotLevel),t=l._dynamicColumns.filter(e=>e.group),r=[];!function e(t,l){for(let i=0;i<t.length;i++){const r=t[i];"right"===a&&r.columnTotal&&e(r.children,l),l.push(r),"left"===a&&r.columnTotal&&e(r.children,l)}}(e,r),t.push(...r),l._dynamicColumns=t,l._addRowTotalsDynamicColumnDefinitions(),l.refresh(void 0,l._getCurrentDataStructure());break}case"conditionalFormatting":l._applyInitialConditionalFormatting(l.rows),l.refresh(void 0,l._getCurrentDataStructure());break;case"dataSource":delete l._filterInfo.appliedFilters,l._sortColumns=[],l._clearDesignerFilters(),l._validateDataSource(),l.refresh(!0);break;case"designer":a&&(l._designer?(l._dialog&&l._dialog.classList.contains("fields")&&l._dialog.close(),l._designer.inverted="near"===l.designerPosition&&!l.rightToLeft||"far"===l.designerPosition&&l.rightToLeft,l.$.designerContainer.appendChild(l._designer)):l._initDesigner(l.$.designerContainer));break;case"designerPosition":l.designer&&(l._designer.inverted="near"===a&&!l.rightToLeft||"far"===a&&l.rightToLeft);break;case"disabled":case"unfocusable":case"keyboardNavigation":super.propertyChangedHandler(e,t,a),l._designer&&(l._designer.unfocusable=l.disabled||l.unfocusable||!l.keyboardNavigation);break;case"filtering":a||l.clearFilters();break;case"grandTotal":a?(l.footerRow="footer",l.freezeFooter=!0,l._createGrandTotalRow(l.rows.boundHierarchy,!0)):(l.footerRow=null,l.freezeFooter=!1,l.$.tableContainer.querySelector("tfoot").remove());break;case"groupLayout":l.refresh(void 0,l._getCurrentDataStructure());break;case"locale":case"messages":if(super.propertyChangedHandler(e,t,a),l._rowGroupColumns){const e=l.$.tableContainer.querySelectorAll(".smart-pivot-table-grouping-header");e[e.length-1].innerHTML=l.localize("groupHeader")}l._designer&&(l._designer[e]=l[e]);break;case"rowTotals":case"rowTotalsPosition":{if(0===l._pivotColumns.length)return;let t=!1;if("rowTotals"===e)a?(t=!0,l._addRowTotalsDynamicColumnDefinitions()):i();else if("rowTotalsPosition"===e){if(!l.rowTotals)return;i(),l._addRowTotalsDynamicColumnDefinitions()}l.refresh(t,l._getCurrentDataStructure());break}case"selection":l.refresh(void 0,l._getCurrentDataStructure()),a?(l.$.tableContainer.setAttribute("aria-multiselectable",!0),l._updateSelectAllState()):l.$.tableContainer.removeAttribute("aria-multiselectable");break;default:super.propertyChangedHandler(e,t,a)}}_updateColumns(e){const t=this,a=t._filterInfo.appliedFilters;if(delete t._filterInfo.appliedFilters,t._sortColumns=[],t._initColumns(),t._designerFiltersApplied)if(e){t._applyingDesignerFilters=!0,t._restoringFilters=!0;for(const e in a)t.addFilter(e,a[e]);delete t._applyingDesignerFilters,delete t._restoringFilters}else t._clearDesignerFilters();t.refresh(!0)}_createElement(){const e=this;e.classList.add("smart-table"),e._cellWidth=parseFloat(getComputedStyle(e.$.container).getPropertyValue("--smart-pivot-table-cell-width")),e._autoScrollCoefficient*=2,e._filterInfo={},e.$.header={offsetHeight:0},e.$.pager={offsetHeight:0},e.grandTotal&&(e.footerRow="footer",e.freezeFooter=!0),e._setMainContainerMaxHeight(),e._localize(),e._validateDataSource(),e._initColumns(),e.refresh(!0),e.designer&&e._initDesigner(e.$.designerContainer)}_setMainContainerMaxHeight(){const e=getComputedStyle(this.$.container).maxHeight;isNaN(parseFloat(e))||(this.$.main.style.maxHeight=`calc(${e} - 2 * var(--smart-border-width)`)}_validateDataSource(){const e=this;e.dataSource instanceof Smart.DataAdapter==!1&&(Array.isArray(e.dataSource)?e.dataSource=new Smart.DataAdapter({dataSource:e.dataSource}):e.dataSource=new Smart.DataAdapter({dataSource:[]}))}_processPivotColumns(){const e=this,t=e.columnTotals,a=e.dataSource,l=[],i=[],r=[],n=[],o=[];let s;if(0===e._columns.length)return!1;for(let a=0;a<e._columns.length;a++){const d=e._columns[a];d.pivot&&d.allowPivot&&(l.push(d),n.push(d.dataField)),d.rowGroup&&d.allowRowGroup&&(i.push(d),o.push(d.dataField)),d.summary&&(r.push(d),s?t&&s!==d.summary&&e.error(e.localize("sameSummaryFunctionRequired",{example:s})):s=d.summary)}return 0===r.length&&e.error(e.localize("summaryRequired")),a.groupBy=n,a.refreshHierarchy(),e.$.rowGroupBreadcrumb.dataSource=i.map(e=>({label:e.label,value:e})),e.$.pivotBreadcrumb.dataSource=l.map(e=>({label:e.label,value:e})),e._primaryHierarchy=a.boundHierarchy,e._groupByPrimary=n,e._groupBySecondary=o,e._pivotColumns=l,e._rowGroupColumns=i,e._aggregateColumns=r,e._totalSummaryFunction=s,!0}refresh(e,t){const a=this,l=a.isRendered;if(a.columns.canNotify=!1,l&&!t&&(a.$.tableContainer.innerHTML=""),t){const e=a.$.tableContainer.firstElementChild,l=document.createDocumentFragment();e.innerHTML="",a._createHeaderCells(t,l),e.appendChild(l)}else{if(!a._processPivotColumns())return;a._createHeader()}e&&(a._createAggregatesSource(),a._applyInitialConditionalFormatting(a.rows)),a._createDataRows(!t);const i=a._sortColumns;l&&(e||t)&&i&&(delete a._sortColumns,i.forEach(e=>{const t=a._getDynamicColumnById[e.dataField];t&&(delete t.sortOrder,a.sortBy(t,e.direction))})),a.columns.canNotify=!0}_createHeader(){const e=this,t=e.columnTotals,a=e.columnTotalsPosition,l=document.createElement("thead"),i=document.createDocumentFragment(),r=e._pivotColumns.length,n=[];function o(a,l,i){if(t)for(let t=0;t<=r;t++)t<a?n[t].push(l[t]):t===a?n[t].push(i.label):t===r?n[t].push(`TL="${a}"${e._totalSummaryFunction}(${e.localize("total")})`):n[t].push("")}function s(a){const l=e._aggregateColumns;return t&&0===a&&n[0].push(`TL="0"${e._totalSummaryFunction}(${e.localize("total")})`),l.forEach(e=>{n[a].push(`${e.summary}(${e.label})`)}),l.length}for(let e=0;e<=r;e++)n.push([]);r>0?function t(l,i,r){let d=0;for(let c=0;c<l.length;c++){const u=l[c];let m=0;e._filterInfo.appliedFilters&&!e._areChildrenFiltered(void 0,u.children)||("near"===a&&o(i,r,u),u.children&&u.children.length>0&&!0!==u.children[0].leaf?m+=t(u.children,i+1,r.concat([u.label])):m+=s(i+1),"far"===a&&o(i,r,u),n[i].push(...Array(m).fill(u.label)),d+=m)}return d}(e._primaryHierarchy,0,[]):s(0),e._createDynamicColumnDefinitions(n),e._createHeaderCells(n,i),l.appendChild(i),e.$.tableContainer.appendChild(l)}_createDynamicColumnDefinitions(e){const t=this,a=e[e.length-1].length,l=[],i=[],r={};let n=-1;t._dynamicColumns=l,t._dynamicDataFields=i,t._getDynamicColumnById=r;for(let o=0;o<a;o++){const a=e[e.length-1][o];if(t._createTotalColumnDefinition(a,e,o))continue;const s={dataFields:[]},d=[];n++;for(let a=0;a<e.length-1;a++){const l=e[a][o],i=t._pivotColumns[a],r={originalColumn:i,label:l,dataField:i.dataField};s.dataFields.push(r),d.push(l),e[a][o]={label:l,columnDefinition:s,info:r}}const c=t._aggregateColumns[n%t._aggregateColumns.length],u={originalColumn:c,label:a,dataField:c.dataField,summary:c.summary};s.dataFields.push(u),d.push(c.dataField),e[e.length-1][o]={label:a,columnDefinition:s,info:u},s.id=d.join(",").replace(/[ ,]/g,"_"),l.push(s),i.push({name:s.id,dataType:"any"}),r[s.id]=s}if(t._rowGroupColumns.length>0){const e=t.localize("groupHeader"),a={dataFields:t._rowGroupColumns.map(t=>({originalColumn:t,label:e})),id:"group",label:e,group:!0};let n;l.unshift(a),r.group=a;for(let e=0;e<a.dataFields.length&&(n=a.dataFields[e].originalColumn.dataType,"string"!==n);e++);i.push({name:"group",dataType:n})}t._setColumnTotalsRelations(),t._addRowTotalsDynamicColumnDefinitions(),t.$.tableContainer.removeAttribute("aria-colcount")}_createTotalColumnDefinition(e,t,a){const l=this,i=/TL="(\d+)"/.exec(e);if(!i)return!1;const r=parseFloat(i[1]),n={dataFields:[]},o=[];e=e.replace(/TL="(\d+)"/,"");for(let e=0;e<t.length-1;e++){if(e>r){t[e][a]=Object.assign({},t[e-1][a],{label:""});continue}const i=t[e][a],s=l._pivotColumns[e],d={originalColumn:s,label:i,dataField:s.dataField};n.dataFields.push(d),o.push(i),t[e][a]={label:i,columnDefinition:n,info:d}}return o.push("TOTAL"),n.columnTotal=!0,n.emptyCells=[],n.expanded=!1,n.id=o.join(",").replace(/[ ,]/g,"_"),n.pivotLevel=r,t[t.length-1][a]={label:e,columnDefinition:n,info:{originalColumn:{},label:e,dataField:"TOTAL"}},l._dynamicColumns.push(n),l._dynamicDataFields.push({name:n.id,dataType:"any"}),l._getDynamicColumnById[n.id]=n,!0}_setColumnTotalsRelations(){const e=this;if(!e.columnTotals)return;const t=e._dynamicColumns;for(let a=0;a<e._dynamicColumns.length;a++){const l=e._dynamicColumns[a];if(!l.columnTotal)continue;const i=l.id.replace("_TOTAL","");let r;0===e._pivotColumns.length?(l.expanded=!0,r=t.filter(e=>{if(!e.columnTotal&&!e.group)return e.parent=l,!0})):r=l.pivotLevel===e._pivotColumns.length-1?t.filter(e=>{if(!e.columnTotal&&0===e.id.indexOf(i))return e.parent=l,!0}):t.filter(e=>{if(e.columnTotal&&e.pivotLevel===l.pivotLevel+1&&0===e.id.indexOf(i))return e.parent=l,!0}),l.children=r}}_addRowTotalsDynamicColumnDefinitions(){const e=this;if(!e.rowTotals||0===e._pivotColumns.length)return;const t=[];e._aggregateColumns.forEach(a=>{const l=a.dataField,i="TOTAL_"+l,r={dataFields:[{originalColumn:a,label:`${a.summary}(${a.label})`,dataField:l,summary:a.summary}],id:i,rowTotal:!0};t.push(r),e._getDynamicColumnById[i]=r,e._dynamicDataFields.push({name:i,dataType:"any"})}),"near"===e.rowTotalsPosition?e._dynamicColumns.splice(0+Number(e._rowGroupColumns.length>0),0,...t):e._dynamicColumns.push(...t)}_createHeaderCells(e,t){const a=this,l=e[e.length-1].length,i=a.columnTotals,r=a.selection,n=a.onColumnRender,o=a.rowTotalsPosition,s=a._rowGroupColumns.length>0,d=a._cellWidth;function c(t,a){if(0===a)return!0;let l=t,i=!1;for(;l>=0&&!i;){const t=e[l][a-1],r=e[l][a];i=t.label!==r.label||JSON.stringify(t.info)!==JSON.stringify(r.info),l--}return i}for(let u=0;u<e.length;u++){const m=document.createElement("tr"),p=e[u];if(r)if(u===e.length-1)m.innerHTML='<th class="smart-pivot-table-selection-header smart-table-select-all freeze-near"><div role="checkbox" aria-checked="false" aria-label="Toggle selection of all rows"></div></th>';else{const e=document.createElement("th");0===u&&(e.style.width=getComputedStyle(a.$.container).getPropertyValue("--smart-table-row-height")),e.classList.add("smart-pivot-table-selection-header","freeze-near"),m.appendChild(e)}s&&a._createGroupHeaderCells(u,e,m),"near"===o&&a._createRowTotalsHeaders(u,e,m);const g={};for(let t=0;t<l;t++){let r=p[t],o=r.label,s=r.columnDefinition;if(void 0===o)break;const h=document.createElement("th");if(c(u,t)){if(g.cell&&!i&&(g.span>1&&(g.cell.colSpan=g.span),0===u&&(g.cell.style.width=d*g.span+"px")),t===l-1&&0===u?i||(h.style.width=d+"px"):(g.cell=h,g.span=1),h.columnDefinition=s,s.columnTotal&&""===o)s.emptyCells.push(h),h.classList.add("empty");else if(n){const e={text:o,cell:h,column:r.info,fullDefinition:s};a.onColumnRender(e),o=e.text}u===e.length-1&&(a._addSortingCapability(h,s),o=`<div class="wrapper" role="presentation"><div class="label">${o}</div></div>`),r.info.originalColumn.align&&h.classList.add("align-"+r.info.originalColumn.align),h.innerHTML=o,i&&a._processColumnTotalsHeaderCells(h,s,u),m.appendChild(h)}else g.span++,t!==l-1||i||(g.cell.colSpan=g.span,0===u&&(g.cell.style.width=d*g.span+"px"))}"far"===o&&a._createRowTotalsHeaders(u,e,m),t.appendChild(m)}}_createGroupHeaderCells(e,t,a){const l=this,i="classic"===l.groupLayout,r=i?l._rowGroupColumns.length:1;for(let n=0;n<r;n++){const r=document.createElement("th");if(r.classList.add("smart-pivot-table-grouping-header"),e===t.length-1){const e=l._dynamicColumns[0];let t=i?e.dataFields[n].originalColumn.label:l.localize("groupHeader");if(l.onColumnRender){const a={text:t,cell:r,column:e.dataFields[0],fullDefinition:e};l.onColumnRender(a),t=a.text}0===n&&(l._addSortingCapability(r,e),t=`<div class="wrapper" role="presentation"><div class="label">${t}</div></div>`),r.innerHTML=t}a.appendChild(r)}}_processColumnTotalsHeaderCells(e,t,a){const l=this,i=l.columnTotalsPosition;if(a<l._pivotColumns.length&&!e.classList.contains("empty")){const r=document.createElement("div");if(r.className="total-arrow smart-arrow smart-arrow-right",r.setAttribute("role","button"),r.setAttribute("aria-label","Toggle column"),!l.keyboardNavigation||l.disabled||l.unfocusable||(r.tabIndex=0),e.appendChild(r),"far"!==i||t.columnTotal)e.controller=t;else{let i=l._pivotColumns.length,r=t;for(;i>a;)r=r.parent,i--;e.controller=r}e.controller.arrowCell=e,l._getColumnTotalColspan(e)}const r=function e(t){return!!t.parent&&(!t.parent.expanded||e(t.parent))}(t);t.hidden=r,"near"===i?(e.classList.toggle("smart-hidden",r),e.classList.toggle("expanded",t.expanded)):(e.controller&&t!==e.controller||e.classList.toggle("smart-hidden",r),t.arrowCell&&t.arrowCell!==e&&(t.arrowCell.classList.toggle("smart-hidden",r),t.arrowCell.classList.toggle("expanded",t.expanded)))}_getColumnTotalColspan(e){const t=function e(t){let a=1;if(t.expanded)for(let l=0;l<t.children.length;l++){const i=t.children[l];i.columnTotal?a+=e(i):a+=1}return a}(e.controller);t>1?e.colSpan=t:e.removeAttribute("colspan"),e.style.width=this._cellWidth*t+"px"}_createRowTotalsHeaders(e,t,a){const l=this;if(l.rowTotals&&0!==l._pivotColumns.length)for(let i=0;i<l._aggregateColumns.length;i++){const r=l._getDynamicColumnById["TOTAL_"+l._aggregateColumns[i].dataField],n=document.createElement("th");if(n.classList.add("smart-pivot-table-total-header"),e===t.length-1){let e=r.dataFields[0].label;if(l.onColumnRender){const t={text:e,cell:n,column:r.dataFields[0],fullDefinition:r};l.onColumnRender(t),e=t.text}n.innerHTML=`<div class="wrapper" role="presentation"><div class="label">${e}</div></div>`,l._addSortingCapability(n,r)}a.appendChild(n)}}_createAggregatesSource(){const e=this,t=e.dataSource,a=e._aggregateColumns,l=[],i=[],r={id:0,totals:[]},n=[],o=e._selectedIds.slice(0);let s;for(let e=0;e<a.length;e++){const t=a[e],l={};l[t.dataField]=[t.summary],i.push(l)}function d(t,a){for(let l=e._groupByPrimary.length-1;l>=0;l--){const i=t[e._groupByPrimary[l]],r=a[e._groupByPrimary[l]];if(i instanceof Date){if(i.getTime()!==r.getTime())return!1}else if(i!==r)return!1}return!0}if(e._originalRecords={},0===e._rowGroupColumns.length?(!function a(l,n){if(0!==e._pivotColumns.length)for(let o=0;o<l.length;o++){const s=l[o];if(s.children&&s.children.length>0){const l=n.concat([s.label]);if(!0!==s.children[0].leaf)a(s.children,l);else{const a=s.children.filter(e=>!1!==e.$.filtered);if(0===a.length)continue;const n=t.summarize(i,a);e._setRowValue(r,l,n,a)}}}else{const a=e.dataSource.toArray().filter(e=>!1!==e.$.filtered);if(0===a.length)return;const l=t.summarize(i,a);e._setRowValue(r,n,l,a)}}(e._primaryHierarchy,[]),l.push(r),n.push(r.id)):(s=e._groupByPrimary[e._groupByPrimary.length-1],function a(r,o,c){let u=e._getSecondaryHierarchy(r);if(o)for(let e=0;e<c.length;e++)u=u[c[e]].children;u.forEach((u,m)=>{let p=u.children.length;if(e._filterInfo.appliedFilters&&(p=e._areChildrenFiltered(void 0,u.children),!1===u.data.$.filtered&&!p))return;const g={},h=new Smart.DataAdapter({dataSource:u.children,dataFields:t.dataFields,groupBy:e._groupByPrimary});o&&(g.parentid=o.id),g.id=(o?o.id:"")+u.label+r,g.level=r,g[e._dynamicColumns[0].id]=`${u.label} (${p})`,g.totals=[],n.push(g.id),function a(l,r,n,o){if(0!==e._pivotColumns.length)for(let c=0;c<l.length;c++){const u=l[c];if(u.children&&u.children.length>0&&!0!==u.children[0].leaf)a(u.children,r,n,o.concat([u.label]));else{const a=r.children.filter(e=>!1!==e.$.filtered&&(!s||d(u.data,e)));if(0===a.length)continue;const l=o.concat([u.label]).filter(e=>void 0!==e),c=t.summarize(i,a);e._setRowValue(n,l,c,a)}}else{const a=r.children.filter(e=>!1!==e.$.filtered);if(a.length>0){const l=t.summarize(i,a);e._setRowValue(n,o,l,a)}}}(h.boundHierarchy||h,u,g,[]),l.push(g),r<e._groupBySecondary.length-1&&a(r+1,g,c.concat([m]))})}(0,void 0,[])),e._setRowTotalsSource(l,i),e._setColumnTotalsSource(l),e.rows=new Smart.DataAdapter({dataSource:l,id:"id",keyDataField:"id",parentDataField:"parentid",dataFields:e._dynamicDataFields}),!e.isRendered&&e.onInit&&e.onInit(),o.length>0){const t=[];for(let e=0;e<o.length;e++)-1!==n.indexOf(o[e])&&t.push(o[e]);e._selectedIds=t}delete e._selectionStart,e.selection&&e._updateSelectAllState()}_setRowValue(e,t,a,l){const i=this;let r=[];i._aggregateColumns.forEach(n=>{const o=n.dataField,s=a[o][n.summary],d=t.concat([o]).join(",").replace(/[ ,]/g,"_");e[d]=s,i._originalRecords[e.id+d]=l,r.push({dataPoint:s})}),e.totals=e.totals.concat(l)}_setRowTotalsSource(e,t){const a=this;if(!a.rowTotals||0===a._pivotColumns.length)return;const l=new Smart.DataAdapter({dataSource:[],dataFields:a.dataSource._dataFields});for(let i=0;i<e.length;i++){const r=e[i],n=r.id,o=r.totals,s=l.summarize(t,o);for(let e in s)r["TOTAL_"+e]=Object.values(s[e])[0],a._originalRecords[n+"TOTAL_"+e]=o;delete r.totals}}_setColumnTotalsSource(e){const t=this;if(!t.columnTotals)return;const a=t._dynamicColumns.filter(e=>e.columnTotal),l=new Smart.DataAdapter({dataSource:[],dataFields:[{name:"dataPoint"}]});for(let i=0;i<e.length;i++){const r=e[i],n=r.id;for(let e=0;e<a.length;e++){const i=a[e],o=t._getColumnTotalsOriginalRecords(i,n);0!==o.length&&(t._originalRecords[n+i.id]=o,r[i.id]=t._getTotalSummary(o,l))}}}_getTotalSummary(e,t){const a=[];return this._aggregateColumns.forEach(t=>{e.forEach(e=>{a.push({dataPoint:e[t.dataField]})})}),t.summarize([{dataPoint:[this._totalSummaryFunction]}],a).dataPoint[this._totalSummaryFunction]}_getSecondaryHierarchy(e){const t=this.dataSource;return t.groupBy=this._groupBySecondary.slice(0,e+1),t.refreshHierarchy(),t.boundHierarchy}_createDataRows(e){const t=this,a=t.rows.boundHierarchy,l=document.createDocumentFragment();let i;a&&("default"===t.groupLayout?t._createRowElements(a,l):(t._expanded=[],t._hidden={},t._rowGroupColumns.forEach((e,a)=>{t._expanded.push([]),t._hidden[a]=!1}),t._createRowElementsClassic(a,l))),l.appendChild(t._createLastRow()),e?(i=document.createElement("tbody"),t.$.tableContainer.appendChild(i)):(i=t.$.tableContainer.querySelector("tbody"),i.innerHTML=""),i.appendChild(l),t._createGrandTotalRow(a,e),"classic"===t.groupLayout&&t._updateGroupColumnsVisibility(),t.getRootNode().activeElement===t.$.tableContainer&&t._tableContainerFocusHandler()}_createRowElements(e,t){const a=this,l=a.selection,i=a._dynamicColumns;for(let r=0;r<e.length;r++){const n=document.createElement("tr"),o=e[r],s=o.level;if(o.tr=n,n.data=o,l){const e=document.createElement("td"),t=-1!==a._selectedIds.indexOf(o.$.id);e.className=`smart-table-select-row freeze-near${t?" selected":""}`,e.innerHTML=`<div class="selection-checkbox" role="checkbox" aria-checked="${t}" aria-label="Toggle row selection"></div>`,n.appendChild(e),n.setAttribute("aria-selected",t)}for(let e=0;e<i.length;e++){const t=document.createElement("td"),l=i[e],r=o[l.id];let d,c,u=r;if(0===e&&l.group){const e=o.leaf;d=l.dataFields[s].originalColumn,u=a._formatCellValue(o,d,t,u),e||(t.classList.add("tree-cell"),c=!0),s>0&&(t.classList.add("outline-level-"+s),e&&t.classList.add("tree-leaf")),d.align&&t.classList.add("align-"+d.align)}else d=l.columnTotal?"total":l.dataFields[l.dataFields.length-1].originalColumn,u=a._formatSummaryValue(o,d,t,u);a.onCellRender&&a.onCellRender(o,l,r,t),a._applyConditionalFormattingToCell(t,l.id,o.$.index),t.setAttribute("data-field",l.id),t.classList.toggle("smart-hidden",!0===l.hidden),a._setCellContent(t,u,c),n.appendChild(t)}o.expanded&&(n.setAttribute("aria-expanded",!0),n.classList.add("expanded")),s>0&&a._isCollapsed(o)&&(n.setAttribute("aria-hidden",!0),n.classList.add("collapsed","smart-hidden")),n.setAttribute("row-id",o.$.id),t.appendChild(n),o.children&&a._createRowElements(o.children,t)}}_createRowElementsClassic(e,t){const a=this,l=a.selection,i=a._dynamicColumns;for(let r=0;r<e.length;r++){const n=e[r],o=n.level;if(o>0&&0===r){n.expanded&&a._expanded[o].push(n),n.children&&a._createRowElementsClassic(n.children,t);continue}const s=document.createElement("tr");let d=a._getRecordToDisplay(n);if(n.tr=s,s.data=n,n.expanded&&(s.setAttribute("aria-expanded",!0),s.classList.add("expanded"),a._expanded[o].push(n)),o>0&&a._isCollapsed(n)&&(s.setAttribute("aria-hidden",!0),s.classList.add("collapsed","smart-hidden")),l){const e=document.createElement("td"),t=-1!==a._selectedIds.indexOf(n.$.id);e.className=`smart-table-select-row freeze-near${t?" selected":""}`,e.innerHTML=`<div class="selection-checkbox" role="checkbox" aria-checked="${t}" aria-label="Toggle row selection"></div>`,s.appendChild(e),s.setAttribute("aria-selected",t)}for(let e=0;e<i.length;e++){const t=i[e];let l,r=n[t.id],o=r;if(0===e&&t.group){a._createGroupCellsClassic(s,n,t,r);continue}const c=document.createElement("td");r=d[t.id],o=r,l=t.columnTotal?"total":t.dataFields[t.dataFields.length-1].originalColumn,o=a._formatSummaryValue(d,l,c,o),a.onCellRender&&a.onCellRender(d,t,r,c),a._applyConditionalFormattingToCell(c,t.id,d.$.index),c.setAttribute("data-field",t.id),c.classList.toggle("smart-hidden",!0===t.hidden),a._setCellContent(c,o),s.appendChild(c)}s.setAttribute("row-id",n.$.id),t.appendChild(s),n.children&&a._createRowElementsClassic(n.children,t)}}_updateGroupColumnsVisibility(){const e=this,t=e._expanded;function a(e){return!e.parent||!!e.parent.expanded&&a(e.parent)}if(!(t.length<2)){for(let l=0;l<t.length-1;l++){const i=t[l],r=l+1;let n=0;if(i.forEach(e=>n+=Number(a(e))),0===n&&!e._hidden[r]||n>0&&e._hidden[r]||e._hidden[l]&&!e._hidden[r]){e._hidden[r]=!e._hidden[r],Array.from(e.$.tableContainer.querySelectorAll(`.smart-pivot-table-grouping-header:nth-child(${r+1+Number(e.selection)})`)).concat(Array.from(e.$.tableContainer.querySelectorAll(`td[data-field="group${r}"]`))).forEach(t=>t.classList.toggle("smart-hidden",e._hidden[r]))}}if(e._focusedCell&&e._focusedCell.classList.contains("smart-hidden")&&-1!==e._focusedCell.getAttribute("data-field").indexOf("group")){let t=e._focusedCell.previousElementSibling;for(;t.classList.contains("smart-hidden");)t=t.previousElementSibling;e._focusCell(t)}}}_getRecordToDisplay(e){return e.leaf||!e.expanded?e:this._getRecordToDisplay(e.children[0])}_getFirstChildAtLevel(e,t){let a=t.children[0];for(;a.children&&a.level!==e;)a=a.children[0];return a}_createGroupCellsClassic(e,t,a,l){const i=this,r=i._rowGroupColumns.length,n=t.level;for(let o=0;o<r;o++){const r=document.createElement("td");if(r.setAttribute("data-field","group"+o),e.appendChild(r),o<n)continue;let s,d=t,c=a.dataFields[o].originalColumn;o>n?(d=i._getFirstChildAtLevel(o,t),l=d[a.id]):r.classList.add("main");const u=i._formatCellValue(d,c,r,l);d.leaf||(r.data=d,s=!0,r.classList.add("tree-cell"),d.expanded&&r.classList.add("expanded","main")),c.align&&r.classList.add("align-"+c.align),i.onCellRender&&i.onCellRender(d,a,l,r),i._applyConditionalFormattingToCell(r,a.id,t.$.index),i._setCellContent(r,u,s)}}_createGrandTotalRow(e,t){const a=this;if(!a.grandTotal||0===a._rowGroupColumns.length||!e)return;const l=a.columnTotals,i=a._dynamicColumns,r=l?new Smart.DataAdapter({dataSource:[],dataFields:[{name:"dataPoint"}]}):void 0,n=document.createElement("tr");let o;function s(e){const t=[{}],i=e.dataFields[e.dataFields.length-1],r=i.dataField;return t[0][r]=[l?a._totalSummaryFunction:i.summary],t}if(a.selection){const e=document.createElement("td");e.className="freeze-near",n.appendChild(e)}for(let t=0;t<i.length;t++){const l=document.createElement("td"),o=i[t];let d,c,u;if(0===t&&o.group)d=a.localize("grandTotal"),c=d;else{const t=o.columnTotal?"total":o.dataFields[o.dataFields.length-1].originalColumn;let i=[];for(let t=0;t<e.length;t++){const l=a._originalRecords[e[t].id+o.id];l&&(i=i.concat(l))}0!==i.length&&(o.columnTotal?(u=a._getTotalSummary(i,r),d=u):(u=a.rows.summarize(s(o),i),d=Object.values(Object.values(u)[0])[0]),a._originalRecords["GRAND_TOTAL"+o.id]=i),c=d,c=a._formatSummaryValue(u,t,l,c)}if(a.onCellRender&&a.onCellRender(u,o,d,l),l.setAttribute("data-field",o.id),l.classList.toggle("smart-hidden",!0===o.hidden),a._setCellContent(l,c),n.appendChild(l),0===t&&o.group&&"classic"===a.groupLayout){l.setAttribute("data-field","group0");for(let e=1;e<a._rowGroupColumns.length;e++){const t=document.createElement("td");t.setAttribute("data-field","group"+e),n.appendChild(t)}}}n.classList.add("grand-total"),t?(o=document.createElement("tfoot"),a.$.tableContainer.appendChild(o)):(o=a.$.tableContainer.querySelector("tfoot"),o.innerHTML=""),o.appendChild(n)}_formatSummaryValue(e,t,a,l){const i=this,r=t.summarySettings;if(!r)return i._formatCellValue(e,t,a,l);if(r.align&&a.classList.add("align-"+r.align),isNaN(l)||""===l|null===l)return l;let n=l;if(void 0!==r.decimalPlaces||void 0!==r.thousandsSeparator||void 0!==r.decimalSeparator){const e=new Smart.Utilities.NumberRenderer(l);void 0!==r.thousandsSeparator&&(e.localizationObject.thousandsseparator=r.thousandsSeparator),void 0!==r.decimalSeparator&&(e.localizationObject.decimalseparator=r.decimalSeparator),n=e.formatNumber(l,"F"+(isNaN(r.decimalPlaces)?"":r.decimalPlaces))}return!0===r.negativesInBrackets&&l<0&&(n=`(${n.toString().replace("-","")})`),void 0!==r.prefix&&(n=r.prefix.toString()+n),n}_overriddenTableHandler(){}_hierarchyArrowClickHandler(e,t){const a=this;let l,i;if("classic"===a.groupLayout){for(t=t&&t.data?t:Array.from(e.querySelectorAll('td[data-field^="group"]')).find(e=>e.data);!t.classList.contains("main")&&!t.previousElementSibling.classList.contains("expanded");)t=t.previousElementSibling;const r=t.data,n=r.level;i=r.children,l=!r.expanded,r.expanded=l,0===n?(e.setAttribute("aria-expanded",l),e.classList.toggle("expanded",l)):n>0&&r===r.parent.children[0]&&t.classList.toggle("main",l);let o=r.children[0],s=t.nextElementSibling;for(;o&&!o.leaf&&o.expanded;)s.classList.toggle("main",l),o=o.children[0],s=t.nextElementSibling;t.classList.toggle("expanded",l),l?a._expanded[n].push(r):a._expanded[n]=a._expanded[n].filter(e=>e!==r),a._updateDisplayedRecord(r,e),a._updateGroupColumnsVisibility()}else{const t=e.data;i=t.children,l=!t.expanded,t.expanded=l,e.setAttribute("aria-expanded",l),e.classList.toggle("expanded",l)}l?requestAnimationFrame(()=>function e(t){t.forEach(t=>{const l=t.children;a._expandSingleChildRow(t.tr),l&&t.expanded&&requestAnimationFrame(()=>e(l))})}(i)):function e(t){t.forEach(t=>{const l=t.children;a._collapseSingleChildRow(t.tr),l&&e(l)})}(i)}_updateDisplayedRecord(e,t){const a=this;if("classic"!==a.groupLayout)return;const l=a._getRecordToDisplay(e);for(let e=0;e<a._dynamicColumns.length;e++){const i=a._dynamicColumns[e],r=i.id;if("group"===r)continue;const n=t.querySelector('td[data-field="'+r+'"]'),o=i.columnTotal?"total":i.dataFields[i.dataFields.length-1].originalColumn;let s=l[i.id];s=a._formatSummaryValue(l,o,n,s),n.style.backgroundColor=null,n.style.color=null,n.style.fontFamily=null,n.style.fontSize=null,a._applyConditionalFormattingToCell(n,i.id,l.$.index),a._setCellContent(n,s)}}_addSortingCapability(e,t){const a=this;t.cell=e,"group"!==t.id&&e.setAttribute("data-field",t.id),0!==a._rowGroupColumns.length&&(t.headerCellElement=e,e.onclick=function(){const l=t.dataFields[t.dataFields.length-1].originalColumn;a.$.fireEvent("columnClick",{columnDefinition:t,dataField:l.dataField}),"none"===a.sortMode||!1===l.allowSort||a._preventClickSort||(a._addSortIconContainer(t),e.sortIconContainerElement.classList.contains("asc")?a.sortBy(t,"desc"):e.sortIconContainerElement.classList.contains("desc")?a.sortBy(t,null):a.sortBy(t,"asc"))})}_sortCallback(e,t,a){const l=this.rows;l._sort(l.boundSource,e,t,a),l.refreshHierarchy(),this._createDataRows()}_selectAllCheckboxClickHandler(e){super._selectAllCheckboxClickHandler(e,this.rows)}_updateSelectAllState(){super._updateSelectAllState(this.rows.length)}_refreshFilters(e){const t=this,a=[];for(const e in t._filterInfo.appliedFilters){let l=t._filterInfo.appliedFilters[e];a.push([e,l])}0!==a.length?(t.dataSource._filter(a,t._applyingDesignerFilters?"and":"or"),t._applyingDesignerFilters||t.refresh(!0),t._restoringFilters&&t.$.fireEvent("filter",{action:e,filters:a})):t.clearFilters()}_areChildrenFiltered(e,t){if(1===arguments.length&&(t=e.children),!t||0===t.length)return;let a=0;for(let e=0;e<t.length;e++)!1===t[e].leaf?a+=this._areChildrenFiltered(void 0,t[e].children)?1:0:!1!==t[e].$.filtered&&a++;return a}_localize(){this.$.rowGroupBreadcrumb.placeholder=this.localize("dragHereRowGroups"),this.$.pivotBreadcrumb.placeholder=this.localize("dragHerePivots"),this.$.conditionalFormattingButton.setAttribute("tooltip",this.localize("conditionalFormatting")),this.$.fieldsButton.setAttribute("tooltip",this.localize("fields"))}_columnNotify(e){const t=this,a=e.propertyName,l=e.target;switch(a){case"allowFilter":{const a=t._designer;if(a&&a._filtersViewInitialized){const i=Array.from(a.$.filtersView.querySelectorAll("smart-filter-panel")).find(e=>e.column.dataField===l.dataField);i&&(!1===e.newValue?(i.closest("smart-accordion-item.filtered")&&(t._clearDesignerFilters(l.dataField),t._designerFilterHandler({target:i})),i.disabled=!0):i.disabled=!1)}break}case"allowPivot":if(!0!==l.pivot)return;break;case"allowRowGroup":if(!0!==l.rowGroup)return;break;case"pivot":if(!0!==l.allowPivot)return;break;case"rowGroup":if(!0!==l.allowRowGroup)return;break;case"summary":if(!e.newValue&&e.oldValue&&1===t._aggregateColumns.length||t.columnTotals&&e.newValue!==t._totalSummaryFunction)return void(l.summary=e.oldValue)}t._refreshColumns()}_refreshColumns(){const e=this;e._columns=e.columns._array,e.columnByDataField=[],e._columns.forEach(t=>e.columnByDataField[t.dataField]=t),e.refresh(!0),e._designer&&(e._designer.columns=JSON.parse(JSON.stringify(e._columns)))}_initDesigner(e){const t=this.rightToLeft,a=document.createElement("smart-pivot-panel");a.animation=this.animation,a.columns=JSON.parse(JSON.stringify(this._columns)),a.dataSource=this.dataSource.toArray(),a.inverted=e===this.$.designerContainer&&("near"===this.designerPosition&&!t||"far"===this.designerPosition&&t),a.locale=this.locale,a.messages=this.messages,a.rightToLeft=t,a.theme=this.theme,a.unfocusable=!this.keyboardNavigation||this.disabled||this.unfocusable,a.ownerElement=this,this._designer=a,e&&e.appendChild(a)}_designerChangeHandler(e){(this.isInShadowDOM?e.composedPath()[0]:e.target)instanceof Smart.PivotPanel!=!1&&(this.columns=e.detail.columns,this._updateColumns(!0))}_designerFilterHandler(){const e=this,t=Array.from(e._designer.$.filtersView.querySelectorAll("smart-filter-panel")),a=[];if(t.forEach(e=>{const t=e.column,l=e.getFilter();l.filters.length>0&&a.push([t.dataField,l])}),e._filterInfo.appliedFilters){if(0===a.length)return void e.clearFilters();delete e._filterInfo.appliedFilters,e.dataSource.clearFilter()}e._applyingDesignerFilters=!0,a.forEach(t=>e.addFilter(...t)),delete e._applyingDesignerFilters,e.refresh(!0),e._designerFiltersApplied=!0}_clearDesignerFilters(e){if(!this._designerFiltersApplied||this._applyingDesignerFilters)return;const t=this._designer,a=t.view,l=Array.from(t.$.filtersView.querySelectorAll("smart-filter-panel"));t.view="filters",l.forEach(t=>{e&&e!==t.column.dataField||(t._filterHandler.excelClear(),t.closest("smart-accordion-item").classList.remove("filtered"))}),t.view=a}_setFocusable(){const e=this,t=!e.keyboardNavigation||e.disabled||e.unfocusable;super._setFocusable(),e._designer&&(e._designer.unfocusable=t);const a=Array.from(e.$.tableContainer.getElementsByClassName("total-arrow"));t?a.forEach(e=>e.removeAttribute("tabindex")):a.forEach(e=>e.setAttribute("tabindex",0))}_addDragFeedback(){const e=this,t=e._dragDetails.Item,a=document.createElement("div");return a.className="smart-table-feedback",a.setAttribute("parent-table-id",e.id),a.innerHTML=t.columnDefinition.dataFields.map(e=>e.label).join("→"),e.theme&&a.setAttribute("theme",e.theme),document.body.appendChild(a),a}_applyColumnReorder(e,t){const a=this.rightToLeft,l=this._dynamicColumns,i=e.Item.columnDefinition,r=t.classList.contains("right"),n=this._dynamicColumns.filter(e=>e!==i),o=n.indexOf(t.columnDefinition);t.classList.remove("drop-column","left","right"),r&&!a||!r&&a?n.splice(o+1,0,i):n.splice(o,0,i),l.map(e=>e.id).join(",")!==n.map(e=>e.id).join(",")&&(this._dynamicColumns=n,this.refresh(void 0,this._getCurrentDataStructure()))}_getCurrentDataStructure(){const e=this,t=e._dynamicColumns,a=[],l=`${e._totalSummaryFunction}(${e.localize("total")})`;let i=Number(e._rowGroupColumns.length>0),r=0;if(e.rowTotals&&e._pivotColumns.length>0){const t=e._aggregateColumns.length;"near"===e.rowTotalsPosition?i+=t:r=t}const n=t.find(e=>!e.rowTotal&&!e.columnTotal&&!e.group).dataFields.length;for(let e=0;e<n;e++)for(let o=i;o<t.length-r;o++){void 0===a[e]&&(a[e]=[]);const i=t[o];if(i.columnTotal){const t=i.dataFields[e];e===n-1?a[e].push({label:l,columnDefinition:i,info:{dataField:"TOTAL",label:l,originalColumn:{}}}):t?a[e].push({label:t.label,columnDefinition:i,info:t}):a[e].push({label:"",columnDefinition:i,info:i.dataFields[e-1]})}else a[e].push({label:i.dataFields[e].label,columnDefinition:i,info:i.dataFields[e]})}return a}_breadcrumbCloseHandler(e){const t=this.columns.find(t=>t.dataField===e.detail.item.value.dataField);t&&((this.isInShadowDOM?e.composedPath()[0]:e.target===this.$.rowGroupBreadcrumb)?t.rowGroup=void 0:t.pivot=void 0)}_breadcrumbDragEndHandler(e){const t=this,a=t.isInShadowDOM?e.composedPath()[0]:e.target,l=a===t.$.rowGroupBreadcrumb,i=t._breadcrumbOperation;let r=t.columns.find(t=>t.dataField===e.detail.item.data.value.dataField);if("forbidden"===i)return void(a.dataSource=l?t._rowGroupColumns.map(e=>({label:e.label,value:e})):t._pivotColumns.map(e=>({label:e.label,value:e})));const n=t.columns;if("remove"!==i){if("reorder"===i){const a=e.detail.target;if(!a)return;const l=a.data.value;if(void 0===r||void 0===l||r.dataField===l.dataField)return;const i=e.detail.droppedBeforeTarget?"top":"bottom",o=n.findIndex(e=>e.dataField===r.dataField);let s=n.findIndex(e=>e.dataField===l.dataField);if(o>s&&"bottom"===i||o<s&&"top"===i)return;n.canNotify=!1,n.splice(o,1),s=n.findIndex(e=>e.dataField===l.dataField),"bottom"===i?n.splice(s+1,0,r):n.splice(s,0,r),t.columns=n,n.canNotify=!0}else i instanceof HTMLElement&&(i.$.container.classList.remove("drop-target"),n.canNotify=!1,i===t.$.rowGroupBreadcrumb||t._designer&&i===t._designer.$.rowGroupsTree?(r.pivot=void 0,r.rowGroup=!0):t._designer&&i===t._designer.$.summariesTree?(r[l?"rowGroup":"pivot"]=void 0,r.summary=t._getDefaultSummaryFunction(r)):(i===t.$.pivotBreadcrumb||t._designer&&i===t._designer.$.pivotsTree)&&(r.rowGroup=void 0,r.pivot=!0),n.canNotify=!0);t._refreshColumns()}else l?r.rowGroup=void 0:r.pivot=void 0}_getDefaultSummaryFunction(e){const t=this;return t.columnTotals?t._totalSummaryFunction:t.getDefaultSummaryFunction?t.getDefaultSummaryFunction(e):"count"}_breadcrumbDraggingHandler(e){const t=this,a=t.isInShadowDOM?e.composedPath()[0]:e.target,l=a._dragDrop.dragDetails.feedback,i=e.detail.item.data.value,r=e.detail.originalEvent,n=t._isMobile?t.getRootNode().elementFromPoint(r.clientX,r.clientY):t.isInShadowDOM?r.composedPath()[0]:r.target;let o,s;if(l){if(l.classList.remove("cancel","delete","row-group","summary","pivot"),t._breadcrumbOperation&&t._breadcrumbOperation instanceof HTMLElement&&t._breadcrumbOperation.$.container.classList.remove("drop-target"),a.contains(n))s="reorder";else if(n===document)o="delete",s="remove";else{const e=t._designer;if(s=n.closest("smart-breadcrumb, smart-tree"),s&&s instanceof Smart.Breadcrumb)s===t.$.rowGroupBreadcrumb&&!i.allowRowGroup||s===t.$.pivotBreadcrumb&&!i.allowPivot?(o="cancel",s="forbidden"):o=s===t.$.rowGroupBreadcrumb?"row-group":"pivot";else if(s&&e&&s!==e.$.columnsTree)switch(s){case e.$.rowGroupsTree:a===t.$.rowGroupBreadcrumb?(o="row-group",s="forbidden"):i.allowRowGroup?o="row-group":(o="cancel",s="forbidden");break;case e.$.summariesTree:o="summary";break;case e.$.pivotsTree:a===t.$.pivotBreadcrumb?(o="pivot",s="forbidden"):i.allowPivot?o="pivot":(o="cancel",s="forbidden")}else o="delete",s="remove"}o&&l.classList.add(o),t._breadcrumbOperation=s,s instanceof HTMLElement&&s.$.container.classList.add("drop-target")}}_tableContainerClickHandler(e){const t=this,a=t.isInShadowDOM?e.composedPath()[0]:e.target;a.classList.contains("total-arrow")?t._totalArrowClickHandler(a):super._tableContainerClickHandler(e)}_tableContainerKeydownHandler(e){const t=this,a=t.getRootNode().activeElement;"Enter"===e.key&&a.classList.contains("total-arrow")?t._totalArrowClickHandler(a):"F2"===e.key&&t._focusedCell?t._drillDown({cell:t._focusedCell,dataField:t._focusedCell.getAttribute("data-field"),rowElement:t._focusedCell.parentElement}):super._tableContainerKeydownHandler(e)}_totalArrowClickHandler(e){const t=this,a=e.parentElement,l=a.controller;l.expanded?(l.expanded=!1,function e(a){if(a.children)for(let l=0;l<a.children.length;l++){const i=a.children[l];Array.from(t.$.tableContainer.querySelectorAll(`td[data-field="${i.id}"]`)).forEach(e=>e.classList.add("smart-hidden")),e(i),i.hidden=!0,i.cell.classList.add("smart-hidden"),i.columnTotal&&(i.arrowCell.classList.add("smart-hidden"),i.emptyCells.forEach(e=>e.classList.add("smart-hidden")))}}(l)):(l.expanded=!0,function e(a){if(a.children)for(let l=0;l<a.children.length;l++){const i=a.children[l];Array.from(t.$.tableContainer.querySelectorAll(`td[data-field="${i.id}"]`)).forEach(e=>e.classList.remove("smart-hidden")),i.expanded&&e(i),i.hidden=!1,i.cell.classList.remove("smart-hidden"),i.columnTotal&&(i.arrowCell.classList.remove("smart-hidden"),i.emptyCells.forEach(e=>e.classList.remove("smart-hidden")))}}(l)),a.classList.toggle("expanded",l.expanded),function e(a){const l=a.controller;t._getColumnTotalColspan(a),l.parent&&e(l.parent.arrowCell)}(a)}_getColumnExportFormat(e,t,a){if(e.columnTotal)return;const l=e.dataFields[e.dataFields.length-1].originalColumn;if(l.align&&(t.textAlign=l.align),e.group||!l.summarySettings)return;const i=l.summarySettings;let r="#.",n=!1;i.align&&(a.textAlign=i.align),void 0!==i.decimalPlaces&&(r+="0".repeat(i.decimalPlaces),n=!0),void 0!==i.prefix&&(r=i.prefix.toString()+r,n=!0),i.negativesInBrackets&&(r=`${r};(${r})`,n=!0),n&&(a.format=r)}_beginEdit(e){this._drillDown(e)}_drillDown(e){const t=this,a=e.dataField;if(/^group\d*$/g.test(a))return;const l=e.rowElement,i=e.cell,r=document.createElement("div"),n=document.createElement("smart-table"),o=t._dynamicColumns.find(e=>e.id===a),s=[],d=JSON.parse(JSON.stringify(t._columns)),c=t.localize("total");let u,m,p,g,h=l.data;if(h)if("classic"===t.groupLayout&&(h=t._getRecordToDisplay(h)),u=h.$.id,h.group){for(m=[h.group.replace(/ \(\d+\)/,"")],g=h.parent;g;)m.push(g.group.replace(/ \(\d+\)/,"")),g=g.parent;m=m.reverse().join("→")}else m=t.localize("notApplicable");else u="GRAND_TOTAL",m=t.localize("grandTotal");if(o.rowTotal)s.push(c);else if(o.columnTotal){for(let e=0;e<=o.dataFields.length-1;e++)s.push(o.dataFields[e].label);s.push(c),p=`${t._totalSummaryFunction}(${c})`}else for(let e=0;e<o.dataFields.length-1;e++)s.push(o.dataFields[e].label);const f=t._originalRecords[u+o.id];f&&0!==f.length&&(r.innerHTML=`<div class="drill-down-details">\n                <span>${t.localize("row")}:</span><strong>${m}</strong>\n                <span>${t.localize("column")}</span><strong>${s.join("→")||t.localize("notApplicable")}</strong>\n                <span>${p||o.dataFields[o.dataFields.length-1].label}:</span><strong>${i.textContent}</strong>\n            </div>`,r.appendChild(n),d.forEach(e=>e.width=t._cellWidth),n.columns=d,n.dataSource=new window.Smart.DataAdapter({dataSource:f,dataFields:t.dataSource._dataFields}),n.freezeHeader=!0,n.keyboardNavigation=t.keyboardNavigation,t._openDialog(t.localize("details"),r,"drill-down"))}_getColumnTotalsOriginalRecords(e,t){const a=this;let l=[];for(let i=0;i<e.children.length;i++){const r=e.children[i];if(!r.columnTotal){const e=a._originalRecords[t+r.id];e&&(l=e);break}l=l.concat(a._getColumnTotalsOriginalRecords(r,t))}return l}_conditionalFormattingButtonClickHandler(e){const t=this._aggregateColumns.map(e=>({label:`${e.summary}(${e.label})`,dataField:e.dataField,dataType:"number"}));super._conditionalFormattingButtonClickHandler(e,t,this.rows)}_applyConditionalFormatting(){const e=this,t=e._conditionalFormatting;e._conditionalFormatting=e._formattingPanel.apply(),e.conditionalFormatting=e._formattingPanel.getItems(),e._conditionalFormatting!==t&&e.refresh(void 0,e._getCurrentDataStructure())}_fieldsButtonClickHandler(){const e=this;e._designer?e._designer.inverted=!1:e._initDesigner(),e._openDialog(e.localize("fields"),e._designer,"fields")}_addDialogHandlers(){const e=this._dialog;e.addEventListener("change",this._dialogEventHandler),e.addEventListener("clear",this._dialogEventHandler),e.addEventListener("filter",this._dialogEventHandler),super._addDialogHandlers()}_dialogEventHandler(e){const t=e.type;if(-1===["change","clear","filter"].indexOf(t))return void super._dialogEventHandler(e);const a=this.ownerElement;if(!(this.isInShadowDOM?e.composedPath()[0]:e.target).closest("smart-pivot-panel"))return;const l=a.context;a.context=a,"change"===t?a._designerChangeHandler(e):a._designerFilterHandler(e),a.context=l}}),Smart("smart-pivot-panel",class extends Smart.BaseElement{static get properties(){return{columns:{value:[],type:"any",reflectToAttribute:!1},dataSource:{value:[],type:"any?",reflectToAttribute:!1},inverted:{value:!1,type:"boolean"},messages:{value:{en:{calculation:"Calculation",cancel:"Cancel",center:"center",clear:"Clear",columns:"Columns",columnSettings:"Column settings",decimalPlaces:"Decimal places",decimalSeparator:"Decimal separator",dragHereRowGroups:"Drag here to set row groups",dragHereSummaries:"Drag here to set summaries",dragHerePivots:"Drag here to set pivots",filter:"Filter",filters:"Filters",left:"left",moveTo:"Move to",negativesInBrackets:"Negatives in brackets",numberAlignment:"Number alignment",numberFormat:"Number format",numberPrefix:"Number prefix",ok:"OK",pivots:"Pivots",right:"right",rowGroups:"Row Groups",search:"Search...",showRows:"Show records where:",summaries:"Summaries",textAlignment:"Text alignment",thousandsSeparator:"Thousands separator"}},type:"object",extend:!0},view:{value:"columns",allowedValues:["columns","filters"],type:"string"}}}static get listeners(){return{keydown:"_keydownHandler","columnsView.click":"_settingsIconClickHandler","columnsView.dragEnd":"_dragEndHandler","columnsView.dragging":"_draggingHandler","filtersView.clear":"_filterPanelFilterHandler","filtersView.expanding":"_accordionItemExpandingHandler","filtersView.filter":"_filterPanelFilterHandler","summariesTree.dragStart":"_summariesTreeDragStartHandler","tabs.click":"_tabsClickHandler"}}template(){return'<div id="container" role="presentation">\n                    <div id="main" role="presentation">\n                        <div id="columnsView" class="smart-pivot-panel-columns-view" role="tabpanel">\n                            <div id="columns" class="smart-pivot-panel-columns-container" role="presentation">\n                                <smart-tree id="columnsTree" allow-drag allow-drop animation="[[animation]]" filterable selection-mode="zeroOrOne" right-to-left="[[rightToLeft]]" theme="[[theme]]" unfocusable="[[unfocusable]]" aria-label="Columns"></smart-tree>\n                            </div>\n                            <div id="rowGroups" class="smart-pivot-panel-active-columns" role="presentation">\n                                <div id="rowGroupsLabel" class="smart-pivot-panel-row-groups-label smart-pivot-panel-label"><span class="icon" aria-hidden="true"></span><span></span></div>\n                                <smart-tree id="rowGroupsTree" allow-drag allow-drop animation="[[animation]]" selection-mode="zeroOrOne" right-to-left="[[rightToLeft]]" theme="[[theme]]" unfocusable="[[unfocusable]]"></smart-tree>\n                            </div>\n                            <div id="summaries" class="smart-pivot-panel-active-columns" role="presentation">\n                                <div id="summariesLabel" class="smart-pivot-panel-summaries-label smart-pivot-panel-label"><span class="icon" aria-hidden="true"></span><span></span></div>\n                                <smart-tree id="summariesTree" allow-drag allow-drop animation="[[animation]]" selection-mode="zeroOrOne" right-to-left="[[rightToLeft]]" theme="[[theme]]" unfocusable="[[unfocusable]]"></smart-tree>\n                            </div>\n                            <div id="pivots" class="smart-pivot-panel-active-columns" role="presentation">\n                                <div id="pivotsLabel" class="smart-pivot-panel-pivots-label smart-pivot-panel-label"><span class="icon" aria-hidden="true"></span><span></span></div>\n                                <smart-tree id="pivotsTree" allow-drag allow-drop animation="[[animation]]" selection-mode="zeroOrOne" right-to-left="[[rightToLeft]]" theme="[[theme]]" unfocusable="[[unfocusable]]"></smart-tree>\n                            </div>\n                        </div>\n                        <div id="filtersView" class="smart-pivot-panel-filters-view" role="tabpanel"></div>\n                    </div>\n                    <div id="tabs" class="smart-pivot-panel-tabs smart-unselectable">\n                        <div id="columnsTab" class="smart-pivot-panel-tab-item" role="tab" aria-selected="false"><span class="icon" aria-hidden="true"></span><span></span></div>\n                        <div id="filtersTab" class="smart-pivot-panel-tab-item" role="tab" aria-selected="false"><span class="icon" aria-hidden="true"></span><span></span></div>\n                    </div>\n                </div>'}render(){const e=this;e._isMobile=Smart.Utilities.Core.isMobile,e._initializedFilters={},e._cachedFilters={},e._setFocusable(),e._localize(),e._setAriaRelations(),e.dataSource instanceof Smart.DataAdapter&&(e.dataSource=e.dataSource.toArray()),"columns"===e.view?(e.$.columnsTab.classList.add("selected"),e.$.columnsTab.setAttribute("aria-selected",!0),e.$.filtersView.remove(),e._initializeColumnsView()):(e.$.filtersTab.classList.add("selected"),e.$.filtersTab.setAttribute("aria-selected",!0),e.$.columnsView.remove(),e._initializeFiltersView()),super.render()}attached(){const e=this;super.attached(),e.isCompleted&&e._dialog&&(e._addDialogHandlers(),e.getShadowRootOrBody().appendChild(e._dialog))}detached(){if(super.detached(),!this._dialog)return;const e=this._dialog;e.removeEventListener("close",this._dialogCloseHandler),e.removeEventListener("click",this._dialogClickHandler),e.remove()}propertyChangedHandler(e,t,a){super.propertyChangedHandler(e,t,a);const l=this;switch(e){case"animation":case"disabled":case"rightToLeft":case"theme":case"unfocusable":if("disabled"!==e&&"unfocusable"!==e||l._setFocusable(),l._columnsViewInitialized&&"filters"===l.view&&[l.$.columnsTree,l.$.rowGroupsTree,l.$.summariesTree,l.$.pivotsTree].forEach(t=>t[e]=a),l._filtersViewInitialized){Array.from(l.$.filtersView.querySelectorAll("smart-filter-panel")).forEach(t=>t[e]=a),"animation"!==e&&(l.$.filtersView.querySelector("smart-accordion")[e]=a)}if(l._dialog){Array.from(l._dialog.$.container.querySelectorAll(".editor, .ok, .cancel")).forEach(t=>t[e]=a),l._dialog[e]=a}break;case"columns":case"dataSource":if("dataSource"===e&&l.dataSource instanceof Smart.DataAdapter&&(l.dataSource=l.dataSource.toArray()),"columns"===e&&l._columnsViewInitialized&&(delete l._columnsViewInitialized,"columns"===l.view&&l._initializeColumnsView()),l._filtersViewInitialized)if("columns"!==e||t.map(e=>e.dataField).join(",")!==a.map(e=>e.dataField).join(",")){if("columns"===e){Array.from(l.$.filtersView.querySelectorAll("smart-accordion-item.filtered smart-filter-panel")).forEach(e=>{l._cachedFilters[e.column.dataField]=e.$.mainContainer.firstElementChild.selectedIndexes})}delete l._filtersViewInitialized,l._initializedFilters={},l.$.filtersView.innerHTML="","filters"===l.view&&l._initializeFiltersView()}else if("columns"===e){Array.from(l.$.filtersView.querySelectorAll("smart-accordion-item, smart-filter-panel")).forEach(e=>{e.column=a.find(t=>t.dataField===e.column.dataField)})}break;case"locale":case"messages":{const e=Array.from(l.$.filtersView.querySelectorAll("smart-filter-panel")),t=l._dialog;l._localize(),e.forEach(e=>{e.messages.en.clear=l.localize("clear"),e.messages.en.filter=l.localize("filter"),e.messages.en.showRows=l.localize("showRows"),e.propertyChangedHandler("messages")}),t&&(t.close(),t.removeEventListener("close",l._dialogCloseHandler),t.removeEventListener("click",l._dialogClickHandler),t.remove(),delete l._dialog);break}case"view":l._tabsClickHandler({target:l.$[a+"Tab"]})}}_localize(){this.$.columnsTab.children[1].innerHTML=this.localize("columns"),this.$.filtersTab.children[1].innerHTML=this.localize("filters"),this.$.columnsTree.filterInputPlaceholder=this.localize("search"),this.$.rowGroupsLabel.children[1].innerHTML=this.localize("rowGroups"),this.$.summariesLabel.children[1].innerHTML=this.localize("summaries"),this.$.pivotsLabel.children[1].innerHTML=this.localize("pivots")}_initializeColumnsView(){this._columnsViewInitialized||(this._columnsViewInitialized=!0,this._createColumnItems())}_initializeFiltersView(){const e=this;if(e._filtersViewInitialized)return;const t=e.columns,a=document.createElement("smart-accordion");e._filtersViewInitialized=!0;for(let l=0;l<t.length;l++){const i=t[l],r=document.createElement("smart-accordion-item");r.label=i.label,r.column=i,0===l&&e._initFilterPanel(r),e._cachedFilters[i.dataField]&&r.classList.add("filtered"),a.appendChild(r)}a.animation="none",a.expandMode="single",a.rightToLeft=e.rightToLeft,a.theme=e.theme,a.unfocusable=e.unfocusable,e.$.filtersView.appendChild(a)}_initFilterPanel(e){const t=this,a=e.column,l=a.dataField;if(t._initializedFilters[l]){const t=e.querySelector("smart-filter-panel");return void(0===t._filterHandler.filterObject.filters.length&&t._filterHandler.tree.select("0"))}const i=document.createElement("smart-filter-panel"),r=a.dataType;i.animation=t.animation,i.column=a,i.disabled=!1===a.allowFilter,i.filterType="number"===r?"numeric":r,i.mode="excel",i.data=t.dataSource,i.dataField=l,i.messages.en.clear=t.localize("clear"),i.messages.en.filter=t.localize("filter"),i.messages.en.showRows=t.localize("showRows"),i.rightToLeft=t.rightToLeft,i.theme=t.theme,i.unfocusable=t.unfocusable,e.isRendered?e.$.contentContainer.appendChild(i):e.appendChild(i),t._initializedFilters[l]=!0,t._cachedFilters[l]&&i.whenRendered((function(){i.$.mainContainer.firstElementChild.selectedIndexes=t._cachedFilters[l],i._filterHandler.excelFilter(),delete t._cachedFilters[l]}))}_accordionItemExpandingHandler(e){const t=this.isInShadowDOM?e.composedPath()[0]:e.target;if(t instanceof Smart.Accordion==!1)return;const a=t._items[e.detail.index];this._initFilterPanel(a)}_filterPanelFilterHandler(e){const t=(this.isInShadowDOM?e.composedPath()[0]:e.target).closest("smart-accordion-item");"clear"!==e.type||t.classList.contains("filtered")||e.stopPropagation(),t.classList.toggle("filtered","filter"===e.type)}_tabsClickHandler(e){const t=this,a=t.view,l=e.type&&t.isInShadowDOM?e.composedPath()[0]:e.target;if(t.$.columnsTab.contains(l)){if("columns"===a&&e.type)return;return t.view="columns",t.$.columnsTab.classList.add("selected"),t.$.columnsTab.setAttribute("aria-selected",!0),t.$.filtersTab.classList.remove("selected"),t.$.filtersTab.setAttribute("aria-selected",!1),t.$.filtersView.remove(),t.$.main.appendChild(t.$.columnsView),void t._initializeColumnsView()}if(t.$.filtersTab.contains(l)){if("filters"===a&&e.type)return;t.view="filters",t.$.filtersTab.classList.add("selected"),t.$.filtersTab.setAttribute("aria-selected",!0),t.$.columnsTab.classList.remove("selected"),t.$.columnsTab.setAttribute("aria-selected",!1),t.$.columnsView.remove(),t.$.main.appendChild(t.$.filtersView),t._initializeFiltersView()}}_createColumnItems(e){const t=this,a=t.columns,l=[],i=[],r=[],n=[];for(let t=0;t<a.length;t++){const o=a[t];o.allowPivot&&o.pivot&&l.push(o),o.allowRowGroup&&o.rowGroup&&i.push(o),o.summary&&r.push(o),!1!==e&&n.push({label:o.label,value:o})}function o(e,a){const l=[];for(let a=0;a<e.length;a++)l.push({label:t._getTreeItemLabel(e[a]),value:e[a]});a.dataSource=l}o(l,t.$.pivotsTree),o(i,t.$.rowGroupsTree),o(r,t.$.summariesTree),!1!==e&&(t.$.columnsTree.dataSource=n)}_summariesTreeDragStartHandler(e){const t=this.$.summariesTree;1===Object.keys(t.items).length&&e.preventDefault()}_draggingHandler(e){const t=this,a=e.detail.data.Feedback,l=e.detail.item.closest("smart-tree"),i=e.detail.originalEvent.originalEvent,r=t._isMobile?t.getRootNode().elementFromPoint(i.clientX,i.clientY):t.isInShadowDOM?i.composedPath()[0]:i.target,n=r.closest("smart-tree"),o=e.detail.item.value,s=t.ownerElement;if(t._breadcrumbTarget&&(t._breadcrumbTarget.$.container.classList.remove("drop-target"),delete t._breadcrumbTarget),s&&s.contains(r)){const e=r.closest("smart-breadcrumb");if(e)return a.classList.remove("forbidden"),e===s.$.rowGroupBreadcrumb?o.allowRowGroup?o.rowGroup||e.$.container.classList.add("drop-target"):a.classList.add("forbidden"):o.allowPivot?o.pivot||e.$.container.classList.add("drop-target"):a.classList.add("forbidden"),void(t._breadcrumbTarget=e)}l===t.$.columnsTree&&!n||n===t.$.rowGroupsTree&&!o.allowRowGroup||n===t.$.pivotsTree&&!o.allowPivot?a.classList.add("forbidden"):a.classList.remove("forbidden")}_dragEndHandler(e){const t=this,a=e.detail,l=a.previousContainer,i=a.container,r=a.item,n=t.columns.find(e=>e.dataField===r.value.dataField),o=a.target,s=a.data.DropDetails?a.data.DropDetails.position:void 0;function d(){switch(i){case t.$.rowGroupsTree:return!!n.allowRowGroup&&(n.rowGroup=!0,!0);case t.$.summariesTree:return n.summary||(n.summary=t._getDefaultSummaryFunction(n)),!0;case t.$.pivotsTree:return!!n.allowPivot&&(n.pivot=!0,!0)}}function c(){const e=document.createElement("smart-tree-item");return e.label=t._getTreeItemLabel(n),e.value=n,e}function u(){if(l!==i)switch(l){case t.$.rowGroupsTree:delete n.rowGroup;break;case t.$.summariesTree:delete n.summary;break;case t.$.pivotsTree:delete n.pivot}}function m(){if(o.value)return t.columns.find(e=>e.dataField===o.value.dataField)}if(t._breadcrumbTarget)t._breadcrumbDropHandler(n,l);else{if(l===t.$.columnsTree){if(i instanceof Smart.Tree==!1)return r.selected=!!(n.pivot||n.rowGroup||n.summary),void e.preventDefault();if(i===l){let e=!1;return(n.rowGroup&&Object.keys(t.$.rowGroupsTree.items).length>1||n.summary&&Object.keys(t.$.summariesTree.items).length>1||n.pivot&&Object.keys(t.$.pivotsTree.items).length>1)&&(e=!0),void requestAnimationFrame(()=>{const a=t.context;t.context=t,t.columns=t.$.columnsTree.dataSource.map(e=>e.value),e&&(t._createColumnItems(!1),t.$.fireEvent("change",{columns:JSON.parse(JSON.stringify(t.columns))})),t.context=a})}return Object.values(i._menuItems).find(e=>e.value===n)||(d()?(0===i.dataSource.length?i.insert({label:t._getTreeItemLabel(n),value:n}):("top"===s?i.addBefore(c(),o):i.addAfter(c(),o),t._reorder(n,m(),s)),t.$.fireEvent("change",{columns:JSON.parse(JSON.stringify(t.columns))})):r.selected=!!(n.pivot||n.rowGroup||n.summary)),void e.preventDefault()}if(i instanceof Smart.Tree==!1||i===t.$.columnsTree)return u(),l.removeItem(r),t.$.fireEvent("change",{columns:JSON.parse(JSON.stringify(t.columns))}),void e.preventDefault();d()?(u(),t._reorder(n,m(),s),t.$.fireEvent("change",{columns:JSON.parse(JSON.stringify(t.columns))})):e.preventDefault()}}_reorder(e,t,a){const l=this.columns,i=l.indexOf(e);let r=l.indexOf(t);void 0===e||void 0===t||i>r&&"bottom"===a||i<r&&"top"===a||(l.splice(i,1),r=l.indexOf(t),"bottom"===a?l.splice(r+1,0,e):l.splice(r,0,e),this.columns=l,this.$.columnsTree.dataSource=l.map(e=>({label:e.label,value:e,selected:!!(e.pivot||e.rowGroup||e.summary)})))}_breadcrumbDropHandler(e,t){const a=this,l=a._breadcrumbTarget,i=a.ownerElement,r=i.columns.find(t=>t.dataField===e.dataField),n=a.context;function o(){switch(a.context=document,i.columns.canNotify=!1,t){case a.$.rowGroupsTree:r.rowGroup=void 0;break;case a.$.summariesTree:r.summary=void 0;break;case a.$.pivotsTree:r.pivot=void 0}}if(l.$.container.classList.remove("drop-target"),delete a._breadcrumbTarget,l===i.$.rowGroupBreadcrumb){if(!e.allowRowGroup||e.rowGroup)return;o(),r.rowGroup=!0}else{if(!e.allowPivot||e.pivot)return;o(),r.pivot=!0}i._refreshColumns(),a.context=n,i.columns.canNotify=!0}_getTreeItemLabel(e){return'<span class="settings-icon"></span>'+e.label}_settingsIconClickHandler(e){const t=this.isInShadowDOM?e.composedPath()[0]:e.target;t.classList.contains("settings-icon")&&this._openDialog(t.closest("smart-tree-item"))}_openDialog(e){const t=this;t._dialog||t._createDialog();const a=t._dialog,l=e.value,i=!!l.summary,r=Array.from(a.$.container.querySelectorAll(".editor"));let n=l.align||"left";if(t.$.container.setAttribute("modal",""),t._editedItem=e,a.classList.toggle("summary",i),a.setAttribute("aria-controls",e.id),r[0].value="",r[0].$.input.dataValue="",r[0].disabled=e.menu===t.$.summariesTree&&1===Object.keys(e.menu.items).length,r[1].value=t.localize(n),r[1].$.input.dataValue=n,i){let e=Object.assign({align:"left",prefix:"",decimalPlaces:0,thousandsSeparator:",",decimalSeparator:".",negativesInBrackets:!1},l.summarySettings||{});r[2].value=l.summary,r[2].disabled=t.ownerElement&&t.ownerElement.columnTotals,r[3].value=t.localize(e.align),r[3].$.input.dataValue=e.align,r[4].value=e.prefix,r[5].value=e.decimalPlaces.toString(),r[6].value=e.thousandsSeparator,r[7].value=e.decimalSeparator,r[8].checked=e.negativesInBrackets}a.open()}_createDialog(){const e=this.id,t=document.createElement("smart-window"),a=document.createElement("template"),l=` animation=${this.animation} theme="${this.theme}"${this.rightToLeft?" right-to-left":""}${this.unfocusable?" unfocusable":""}`;a.innerHTML=`<smart-button class="ok primary"${l}>${this.localize("ok")}</smart-button>\n<smart-button class="cancel"${l}>${this.localize("cancel")}</smart-button>`;const i=JSON.stringify([{label:this.localize("columns"),value:"columns"},{label:this.localize("rowGroups"),value:"rowGroups"},{label:this.localize("summaries"),value:"summaries"},{label:this.localize("pivots"),value:"pivots"}]),r=JSON.stringify([{label:this.localize("left"),value:"left"},{label:this.localize("center"),value:"center"},{label:this.localize("right"),value:"right"}]),n=JSON.stringify(["min","max","sum","avg","stdev","stdevp","var","varp","product","count","median"]);t.animation=this.animation,t.footerTemplate=a,t.headerButtons=["close"],t.label=this.localize("columnSettings"),t.rightToLeft=this.rightToLeft,t.theme=this.theme,t.unfocusable=this.unfocusable,t.className="smart-pivot-window",t.innerHTML=`<div id="${e}MoveToLabel" class="label">${this.localize("moveTo")}</div>\n            <div><smart-input class="editor underlined move-to"${l} data-source='${i}' drop-down-button-position="right" readonly aria-labelledby="${e}MoveToLabel"></smart-input></div>\n            <div id="${e}TextAlignmentLabel" class="label">${this.localize("textAlignment")}</div>\n            <div><smart-input class="editor underlined text-alignment"${l} data-source='${r}' drop-down-button-position="right" readonly aria-labelledby="${e}TextAlignmentLabel"></smart-input></div>\n            <div id="${e}CalculationLabel" class="label summary">${this.localize("calculation")}</div>\n            <div class="summary"><smart-input class="editor underlined calculation"${l} data-source='${n}' drop-down-button-position="right" readonly aria-labelledby="${e}CalculationLabel"></smart-input></div>\n            <div class="label category summary">${this.localize("numberFormat")}</div>\n            <div id="${e}NumberAlignmentLabel" class="label summary">${this.localize("numberAlignment")}</div>\n            <div class="summary"><smart-input class="editor underlined number-alignment"${l} data-source='${r}' drop-down-button-position="right" readonly aria-labelledby="${e}NumberAlignmentLabel"></smart-input></div>\n            <div id="${e}NumberPrefixLabel" class="label summary">${this.localize("numberPrefix")}</div>\n            <div class="summary"><smart-input class="editor underlined number-prefix"${l} aria-labelledby="${e}NumberPrefixLabel"></smart-input></div>\n            <div id="${e}DecimalPlacesLabel" class="label summary">${this.localize("decimalPlaces")}</div>\n            <div class="summary"><smart-input class="editor underlined decimal-places"${l} aria-labelledby="${e}DecimalPlacesLabel"></smart-input></div>\n            <div id="${e}ThousandsSeparatorLabel" class="label summary">${this.localize("thousandsSeparator")}</div>\n            <div class="summary"><smart-input class="editor underlined thousands-separator"${l} aria-labelledby="${e}ThousandsSeparatorLabel"></smart-input></div>\n            <div id="${e}DecimalSeparatorLabel" class="label summary">${this.localize("decimalSeparator")}</div>\n            <div class="summary"><smart-input class="editor underlined decimal-separator"${l} aria-labelledby="${e}DecimalSeparatorLabel"></smart-input></div>\n            <div id="${e}NegativesInBracketsLabel" class="label summary">${this.localize("negativesInBrackets")}</div>\n            <div class="summary"><smart-check-box class="editor"${l} aria-labelledby="${e}NegativesInBracketsLabel"></smart-check-box></div>`,t.ownerElement=this,this._dialog=t,this._addDialogHandlers(),this.getShadowRootOrBody().appendChild(t),this.setAttribute("aria-owns",t.id)}_addDialogHandlers(){const e=this._dialog;e.addEventListener("close",this._dialogCloseHandler),e.addEventListener("click",this._dialogClickHandler)}_dialogClickHandler(e){const t=this,a=t.isInShadowDOM?e.composedPath()[0]:e.target;a.closest(".ok")?(t.ok=!0,t.close()):a.closest(".cancel")&&t.close()}_dialogCloseHandler(){const e=this.ownerElement,t=e._dialog,a=e.context;if((t.isInShadowDOM?event.composedPath()[0]:event.target)!==t)return;const l=e._editedItem;if(e.context=e,e.$.container.removeAttribute("modal"),l.menu.focus(),t.ok){const a=l.value,i=Array.from(t.$.container.querySelectorAll(".editor")),r=i[0].$.input.dataValue,n=i[1].$.input.dataValue;let o=!1,s=!1;if(r&&!("rowGroups"===r&&(a.rowGroup||!a.allowRowGroup)||"summaries"===r&&a.summary||"pivots"===r&&(a.pivot||!a.allowPivot))){const t=l.menu;let i;switch(t.removeItem(l.path),t){case e.$.rowGroupsTree:delete a.rowGroup;break;case e.$.summariesTree:delete a.summary;break;case e.$.pivotsTree:delete a.pivot}switch(r){case"rowGroups":i=e.$.rowGroupsTree,a.rowGroup=!0;break;case"summaries":i=e.$.summariesTree,a.summary=e._getDefaultSummaryFunction(a),s=!0;break;case"pivots":i=e.$.pivotsTree,a.pivot=!0}if(i){const t=document.createElement("smart-tree-item");t.label=e._getTreeItemLabel(a),t.value=a,i.addTo(t),t.previousElementSibling&&e._reorder(a,t.previousElementSibling.value,"bottom")}o=!0}if((!a.align&&"left"!==n||a.align&&a.align!==n)&&(a.align=n,o=!0),a.summary&&!s){const e={align:"left",prefix:"",decimalPlaces:0,thousandsSeparator:",",decimalSeparator:".",negativesInBrackets:!1},t=a.summarySettings,l={align:i[3].$.input.dataValue,prefix:i[4].value,decimalPlaces:parseFloat(i[5].value),thousandsSeparator:i[6].value,decimalSeparator:i[7].value,negativesInBrackets:i[8].checked},r=i[2].value;if(isNaN(l.decimalPlaces)&&(l.decimalPlaces=t?t.decimalPlaces:0),r!==a.summary&&(a.summary=r,o=!0),t){const i=Object.assign({},e,t);Object.keys(i).forEach(e=>{i[e]!==l[e]&&(a.summarySettings[e]=l[e],o=!0)})}else JSON.stringify(e)!==JSON.stringify(l)&&(a.summarySettings=l,o=!0)}delete t.ok,o&&e.$.fireEvent("change",{columns:JSON.parse(JSON.stringify(e.columns))})}delete e._editedItem,e.context=a}_setFocusable(){const e=this;if(e.disabled||e.unfocusable)return e.$.columnsTab.removeAttribute("tabindex"),void e.$.filtersTab.removeAttribute("tabindex");const t=e.$.columnsTab.getAttribute("tabindex");(null===t||t<0)&&(e.$.columnsTab.setAttribute("tabindex",0),e.$.filtersTab.setAttribute("tabindex",0))}_keydownHandler(e){const t=this,a=e.key,l=t.getRootNode().activeElement;if("Enter"!==a&&" "!==a||l!==t.$.columnsTab&&l!==t.$.filtersTab){if("Enter"===a&&-1!==[t.$.rowGroupsTree,t.$.summariesTree,t.$.pivotsTree].indexOf(l)){const e=l.querySelector("[focus]");e&&this._openDialog(e)}}else t._tabsClickHandler({target:l})}_getDefaultSummaryFunction(e){const t=this.ownerElement;return t&&t._getDefaultSummaryFunction?t._getDefaultSummaryFunction(e):"count"}_setAriaRelations(){const e=this.id;this.setAttribute("role","tablist"),this.$.columnsView.id=e+"ColumnsView",this.$.columnsTab.id=e+"columnsTab",this.$.columnsTab.setAttribute("aria-controls",this.$.columnsView.id),this.$.columnsView.setAttribute("aria-labelledby",this.$.columnsTab.id),this.$.filtersView.id=e+"FiltersView",this.$.filtersTab.id=e+"FiltersTab",this.$.filtersTab.setAttribute("aria-controls",this.$.filtersView.id),this.$.filtersView.setAttribute("aria-labelledby",this.$.filtersTab.id),this.$.rowGroupsLabel.id=e+"RowGroupsLabel",this.$.rowGroupsTree.setAttribute("aria-labelledby",this.$.rowGroupsLabel.id),this.$.summariesLabel.id=e+"SummariesLabel",this.$.summariesTree.setAttribute("aria-labelledby",this.$.summariesLabel.id),this.$.pivotsLabel.id=e+"PivotsLabel",this.$.pivotsTree.setAttribute("aria-labelledby",this.$.pivotsLabel.id)}})}});